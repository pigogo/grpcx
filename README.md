# grpcx

`gRPCX` 是一个复用了大部分gRPC接口并对其做了个性化扩展的rpc框架，大部分代码已经重新，没有精确统计，预计80%；之所以开发这个框架，是希望能改善gRPC框架的性能和内存问题，同时对分布式系统做更好的个性化支持.`gRPCX`对传输层做了改动，目前没有支持http2，可以指定支持tcp，unix，quic等.


## 框架特征

- 增加通道的支持：在分布式系统中，经常有时序要求的请求，在框架中增加通道显得非常重要。`gRPCX`采用的是动态通道算法，非固定的静态通道，增加数据公平竞争性；同时也对通道并发数做了控制
- 增加连接事件插件：通过option指定plugin
- 增加单向请求的支持
- 增加自定义RawHandler和Struct作为service的注册机制
- 增加框架内的PING/PONG健康监测选项
- 增加服务端的通知：即支持Server端SentTo到客户端
- 增加异步请求支持
- 增加业务层对Metadata的获取支持
- 增加客户端失败重试的机制
- 支持rpc流，同gRPC，需将pb内引用gRPC的地方改成引用`gRPCX`
- 支持多种编码：默认使用pb，可通过option自定义，同gRPC
- 支持压缩：支持gzip压缩，同gRPC
- 支持加密授权：支持tls，同gRPC
- 支持并发控制：可通过option设置通道的并发数和请求数的并发数；gRPC采用的是流量控制
- 支持Graceful关闭：同gRPC
- 负载均衡：提供option扩展，当前支持Roundroubin方法，计划支持hash和一致性hash等,选择性支持居于最少请求，最少连接，ping，最快响应等动态负载均衡算法
- 服务发现：提供option扩展，支持zk和etcd
- 去除了gRPC一些不常用的功能，例如请求劫持，reflection，state，trace等

-----

## 关于性能

### 测试环境描述

- 机器配置(VMWare 虚拟机)：

CPU:    Intel(R) Xeon(R) CPU E5-2620 v4 @ 2.10GHz, 8Cores
Memory:   8G
OS: CentOS release 6.5 (Final)
GO: 1.90

- 客户端服务端在同一台机器
- 总共发送100万个请求，平均分配给每一个客户端
- PING/PONG测试，发送数据长度为300个字节
- 建立连接时间不含在内
- 通讯协议tcp

### 测试结果

|客户端数量\QPS|gRPC|rpcx|golang rpc|gRPCX|
|-------------|-------------|--------------|--------------|-----------|
|1|6157|12800|13594|14715|
|500|54371|132515|196337|211633|
|2500|51092|116163|162855|176625|
|5000|49629|114890|157471|171754|
|10000|47519|108784|146681|163357|

|客户端数量\平均时延|gRPC|rpcx|golang rpc|gRPCX|
|-------------|-------------|--------------|--------------|-----------|
|1|0.16ms|0.08ms|0.07ms|0.07ms|
|500|9ms|3ms|2ms|2ms|
|2500|48ms|21ms|15ms|14ms|
|5000|98ms|42ms|31ms|29ms|
|10000|199ms|89ms|66ms|60ms|

|客户端数量\最大时延|gRPC|rpcx|golang rpc|gRPCX|
|-------------|-------------|--------------|--------------|-----------|
|1|10ms|6ms|2ms|10ms|
|500|64ms|36ms|23ms|23ms|
|2500|318ms|150ms|94ms|90ms|
|5000|713ms|289ms|205ms|182ms|
|10000|1.41s|1.37|348ms|409ms|

|客户端数量\P99时延|gRPC|rpcx|golang rpc|gRPCX|
|-------------|-------------|--------------|--------------|-----------|
|1  | 1ms|0.67ms| 0.2ms|0.5ms|
|500| 34ms|21ms|13ms|11ms|
|2500|171ms| 103ms|60ms|45ms|
|5000|314ms| 178ms|169ms|99ms|
|10000|991ms|333ms|285ms|211ms|
